# Events block - defines connection processing settings
events {
    worker_connections 1024;  # Maximum number of simultaneous connections per worker process
}

# HTTP block - main configuration for HTTP server
http {
    include /etc/nginx/mime.types;        # Include file that maps file extensions to MIME types
    default_type application/octet-stream; # Default MIME type for unknown file extensions

    # Logging configuration
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '  # Define custom log format
                    '$status $body_bytes_sent "$http_referer" '               # Include status, bytes sent, referer
                    '"$http_user_agent" "$http_x_forwarded_for"';            # Include user agent and forwarded IP
    access_log /var/log/nginx/access.log main;  # Log all requests to access.log using 'main' format
    error_log /var/log/nginx/error.log;         # Log errors to error.log

    # Performance optimization settings
    sendfile on;              # Use kernel sendfile() for efficient file serving
    tcp_nopush on;           # Send headers and file in one packet (when sendfile is on)
    tcp_nodelay on;          # Don't buffer small packets, send immediately
    keepalive_timeout 65;    # Keep connections alive for 65 seconds to reuse them
    types_hash_max_size 2048; # Maximum size of MIME types hash table

    # Gzip compression configuration
    gzip on;                 # Enable gzip compression
    gzip_vary on;           # Add "Vary: Accept-Encoding" header for caches
    gzip_min_length 1024;   # Only compress files larger than 1024 bytes
    gzip_proxied expired no-cache no-store private auth;  # Compress responses for these proxy conditions
    gzip_types              # File types to compress
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;

    # Server block - virtual server configuration
    server {
        listen 80;                          # Listen on port 80 (HTTP)
        server_name localhost;              # Server name (can be domain name or IP)
        root /usr/share/nginx/html;         # Document root directory where files are served from
        index index.html index.htm;        # Default files to serve when directory is requested

        # Handle React Router (client-side routing)
        location / {
            try_files $uri $uri/ /index.html;  # Try file, then directory, then fallback to index.html for SPA routing
        }

        # Cache static assets for better performance
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {  # Match static file extensions
            expires 1y;                                    # Set cache expiry to 1 year
            add_header Cache-Control "public, no-transform"; # Allow public caching, prevent transformations
        }

        # Security headers to protect against common attacks
        add_header X-Frame-Options "SAMEORIGIN" always;                    # Prevent clickjacking (allow same origin frames)
        add_header X-Content-Type-Options "nosniff" always;               # Prevent MIME type sniffing attacks
        add_header X-XSS-Protection "1; mode=block" always;               # Enable XSS protection in browsers
        add_header Referrer-Policy "no-referrer-when-downgrade" always;   # Control referrer information sent
        add_header Content-Security-Policy "default-src 'self' http: https: ws: wss: data: blob: 'unsafe-inline'; frame-ancestors 'self';" always;  # CSP to prevent XSS and other attacks

        # Health check endpoint for monitoring
        location /health {
            access_log off;                    # Don't log health check requests
            return 200 "healthy\n";           # Return HTTP 200 with "healthy" text
            add_header Content-Type text/plain; # Set content type to plain text
        }
    }
}